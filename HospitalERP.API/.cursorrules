# ============================================================
#  Hospital ERP - Vertical Slice Architecture (Cursor Rules)
# ============================================================
# Purpose:
# Enforce consistent vertical slicing, CQRS, DTO structure,
# Keycloak security, and domain-driven modularity.
# Cursor AI and all developers MUST follow these rules.
#
# Project:
# - .NET 9 Web API
# - Vertical Feature Slices
# - Light CQRS (Commands + Queries folders)
# - EF Core
# - SQL Server
# - Keycloak JWT
# - Angular Frontend
# ============================================================

rules:

  # ------------------------
  # GLOBAL ARCHITECTURE RULES
  # ------------------------
  - The project MUST be structured using **Vertical Slices**.
    All code MUST go inside `/Features/<FeatureName>/`.

  - Allowed feature modules:
      Patients
      Appointments
      MedicalRecords
      Employees
      Departments
      Medications
      Inventory
      Services
      Invoices
      Dashboard
      Users (Admin)
    No new modules can be added without documentation.

  - Each feature MUST contain:
      /Commands
      /Queries
      /Dtos
      /Mappings
      /Validators (optional)
      /Models (optional business rules)
      <FeatureName>Controller.cs

  - NO global Services folder.
    NO global DTO folder.
    NO global Repository folder.
    NO logic outside its feature folder.

  - Every API endpoint MUST correspond to:
      * A Query (for GET operations)
      * A Command (for POST/PUT/PATCH/DELETE)

  - Each Command/Query MUST be handled by a corresponding Handler class.

  - All Handlers MUST use `HospitalDbContext` via DI.

  - All returned responses MUST use:
      - DTOs (never EF entities)
      - `PaginatedResponse<T>` for paged GET lists

  - Use `AsNoTracking()` for all GET queries.

  - Commands MUST validate foreign keys and return NotFound when invalid.

  - Each feature MUST have a dedicated AutoMapper profile file in `/Mappings`.

  - Controller methods MUST be thin (1–5 lines) and call Mediator.

  # ------------------------
  # CONTROLLER GENERATION RULES
  # ------------------------
  - Controller File Location:
      /Features/<FeatureName>/<FeatureName>Controller.cs

  - Controller Naming:
      <FeatureName>Controller

  - Usage:
      - Inject IMediator
      - Route pattern: [Route("api/<feature-name>")]
      - Always use [ApiController]

  - Each endpoint MUST:
      * return IActionResult
      * wrap logic in Mediator.Send()
      * use Commands/Queries only

  - Authorization must use Keycloak roles:
      [Authorize(Roles = "Admin")]
      [Authorize(Roles = "Doctor")]
      [Authorize(Roles = "Receptionist")]
      [Authorize(Roles = "Pharmacist")]
      [Authorize(Roles = "Accountant")]
      [Authorize(Roles = "HR")]

  - Feature-specific security:
      Patients → Admin, Doctor, Receptionist
      MedicalRecords → Admin, Doctor
      Appointments → Admin, Doctor, Receptionist
      Employees → Admin, HR
      Medications → Admin, Pharmacist
      Inventory → Admin, Pharmacist
      Invoices → Admin, Accountant, Receptionist
      Dashboard → Admin (admin endpoint), HR (hr endpoint), Accountant (accountant endpoint)

  # ------------------------
  # COMMANDS STRUCTURE
  # ------------------------
  command-pattern: |
      namespace HospitalERP.API.Features.{{feature}}.Commands;

      public record {{CommandName}} : IRequest<{{ReturnType}}>
      {
          // Properties
      }

      public class {{CommandName}}Handler 
          : IRequestHandler<{{CommandName}}, {{ReturnType}}>
      {
          private readonly HospitalDbContext _context;
          private readonly IMapper _mapper;

          public {{CommandName}}Handler(HospitalDbContext context, IMapper mapper)
          {
              _context = context;
              _mapper = mapper;
          }

          public async Task<{{ReturnType}}> Handle(
              {{CommandName}} request, 
              CancellationToken cancellationToken
          )
          {
              // Business Logic Here
          }
      }

  # ------------------------
  # QUERIES STRUCTURE
  # ------------------------
  query-pattern: |
      namespace HospitalERP.API.Features.{{feature}}.Queries;

      public record {{QueryName}} : IRequest<{{ReturnType}}>
      {
          // Query Parameters
      }

      public class {{QueryName}}Handler 
          : IRequestHandler<{{QueryName}}, {{ReturnType}}>
      {
          private readonly HospitalDbContext _context;
          private readonly IMapper _mapper;

          public {{QueryName}}Handler(HospitalDbContext context, IMapper mapper)
          {
              _context = context;
              _mapper = mapper;
          }

          public async Task<{{ReturnType}}> Handle(
              {{QueryName}} request, 
              CancellationToken cancellationToken
          )
          {
              var q = _context.{{DbSet}}
                  .AsNoTracking()
                  // Filters
                  .AsQueryable();

              return new PaginatedResponse<{{DtoName}}>(...);
          }
      }

  # ------------------------
  # DTO RULES
  # ------------------------
  - DTOs MUST reside in:
      /Features/<FeatureName>/Dtos/

  - Required DTOs:
      Create<Feature>Dto
      Update<Feature>Dto
      <Feature>ListDto
      <Feature>DetailDto

  - Update DTO extends Create DTO.

  - List DTO = minimal subset
    Detail DTO = full relational info

  # ------------------------
  # VALIDATION RULES
  # ------------------------
  - All Create/Update DTOs MUST have FluentValidation validators.
  - Validators go in:
      /Features/<FeatureName>/Validators/

  # ------------------------
  # MAPPING RULES
  # ------------------------
  - Every feature MUST have:
      /Features/<FeatureName>/Mappings/<Feature>Profile.cs

  - AutoMapper profiles MUST map:
      Entity → Dto
      Dto → Entity

  # ------------------------
  # DATABASE RULES
  # ------------------------
  - Every relation MUST have foreign key constraints.
  - Use HasIndex() for search filters.
  - All domain models MUST be in /Models/Entities.

  # ------------------------
  # COMMON INFRA RULES
  # ------------------------
  - Pagination classes go in /Common/Pagination/
  - QueryParams.cs MUST be reusable across all features.
  - Exceptions in /Common/Exceptions/

  # ------------------------
  # SECURITY RULES (KEYCLOAK)
  # ------------------------
  - All endpoints MUST use [Authorize].
  - Admin endpoints MUST require role Admin.
  - User management endpoints reside ONLY in /Features/Users/.

